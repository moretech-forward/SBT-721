<body id="itrf">
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link href="./output.css" rel="stylesheet"/>
<link
        rel="stylesheet"
        type="text/css"
        href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css"
/>
<section
        data-theme="dark"
        class="mt-20 flex items-center flex-col gap-10 min-h-screen bg-base-100"
>
    <h1 class="text-center text-3xl font-extrabold text-white">
        Soulbound Token (ERC721) - Admin
    </h1>
    <div role="tablist" class="tabs tabs-boxed">
        <a
                role="tab"
                id="mint-tab"
                class="tab tab-active transition-all duration-200"
        >
            Mint
        </a>
        <a role="tab" id="burn-tab" class="tab transition-all duration-200">
            Burn
        </a>
        <a role="tab" id="batch-tab" class="tab transition-all duration-200">
            Batch
        </a>
    </div>
    <div id="tab-1" class="card w-96 bg-base-100 shadow-xl">
        <form id="mint_form" class="card-body flex flex-col gap-6">
            <div class="flex flex-col gap-2">
                <label for="wallet_address">Wallet address</label>
                <input
                        type="text"
                        id="wallet_address"
                        name="wallet_address"
                        placeholder="Enter address"
                        class="input input-bordered w-full max-w-xs"
                        required
                />
            </div>
            <div class="flex flex-col gap-2">
                <label for="metadata_link">Metadata Link</label>
                <input
                        type="text"
                        id="metadata_link"
                        name="metadata_link"
                        placeholder="Enter metadata link"
                        class="input input-bordered w-full max-w-xs"
                        required
                />
            </div>
            <button class="btn btn-primary">Mint</button>
        </form>
    </div>

    <div id="tab-2" class="card w-96 bg-base-100 shadow-xl hidden">
        <form id="burn_form" class="card-body flex flex-col gap-6">
            <div class="flex flex-col gap-2">
                <label for="id">ID</label>
                <input
                        type="number"
                        id="id"
                        name="id"
                        placeholder="Enter id to burn"
                        class="input input-bordered w-full max-w-xs"
                        required
                />
            </div>
            <button class="btn btn-primary">Burn</button>
        </form>
    </div>

    <div id="tab-3" class="card w-96 bg-base-100 shadow-xl hidden">
        <form id="batch_form" class="card-body flex flex-col gap-6">
            <div class="flex flex-col gap-2">
                <label for="metadata_uri">Metadata Link</label>
                <input
                        type="number"
                        id="metadata_uri"
                        name="metadata_uri"
                        placeholder="Enter metadata link"
                        class="input input-bordered w-full max-w-xs"
                        required
                />
            </div>
            <div class="flex flex-col gap-2">
                <label for="id">Addresses</label>
                <textarea
                        id="addresses"
                        name="addresses"
                        class="textarea textarea-bordered min-h-36 max-h-96"
                        placeholder="Enter your addresses"
                ></textarea>
            </div>
            <button class="btn btn-primary">Batch</button>
        </form>
    </div>
</section>

<script>
    const tabs = document.querySelectorAll(".tab");
    const cards = document.querySelectorAll(".card");

    tabs.forEach((tab, index) => {
        tab.addEventListener("click", () => {
            // Remove 'tab-active' class from all tabs
            tabs.forEach((tab) => tab.classList.remove("tab-active"));
            // Add 'tab-active' class to the clicked tab
            tab.classList.add("tab-active");

            // Hide all cards
            cards.forEach((card) => card.classList.add("hidden"));
            // Show the corresponding card (index + 1 because index is 0-based)
            document.getElementById(`tab-${index + 1}`).classList.remove("hidden");
        });
    });
</script>
<script
        src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.12.1/ethers.umd.min.js"
        type="application/javascript"
></script>
<script>
    const abi = [
        {
            inputs: [
                {
                    internalType: "string",
                    name: "_name",
                    type: "string",
                },
                {
                    internalType: "string",
                    name: "_symbol",
                    type: "string",
                },
            ],
            stateMutability: "payable",
            type: "constructor",
        },
        {
            anonymous: false,
            inputs: [
                {
                    indexed: true,
                    internalType: "address",
                    name: "user",
                    type: "address",
                },
                {
                    indexed: true,
                    internalType: "address",
                    name: "newOwner",
                    type: "address",
                },
            ],
            name: "OwnershipTransferred",
            type: "event",
        },
        {
            anonymous: false,
            inputs: [
                {
                    indexed: true,
                    internalType: "address",
                    name: "from",
                    type: "address",
                },
                {
                    indexed: true,
                    internalType: "address",
                    name: "to",
                    type: "address",
                },
                {
                    indexed: true,
                    internalType: "uint256",
                    name: "id",
                    type: "uint256",
                },
            ],
            name: "Transfer",
            type: "event",
        },
        {
            inputs: [
                {
                    internalType: "address",
                    name: "owner",
                    type: "address",
                },
            ],
            name: "balanceOf",
            outputs: [{internalType: "uint256", name: "", type: "uint256"}],
            stateMutability: "view",
            type: "function",
        },
        {
            inputs: [
                {
                    internalType: "uint256",
                    name: "id",
                    type: "uint256",
                },
            ],
            name: "burn",
            outputs: [],
            stateMutability: "payable",
            type: "function",
        },
        {
            inputs: [],
            name: "name",
            outputs: [{internalType: "string", name: "", type: "string"}],
            stateMutability: "view",
            type: "function",
        },
        {
            inputs: [],
            name: "owner",
            outputs: [{internalType: "address", name: "", type: "address"}],
            stateMutability: "view",
            type: "function",
        },
        {
            inputs: [
                {
                    internalType: "uint256",
                    name: "id",
                    type: "uint256",
                },
            ],
            name: "ownerOf",
            outputs: [
                {
                    internalType: "address",
                    name: "owner",
                    type: "address",
                },
            ],
            stateMutability: "view",
            type: "function",
        },
        {
            inputs: [
                {
                    internalType: "address[]",
                    name: "to",
                    type: "address[]",
                },
                {
                    internalType: "string[]",
                    name: "uris",
                    type: "string[]",
                },
            ],
            name: "safeBatchMint",
            outputs: [],
            stateMutability: "payable",
            type: "function",
        },
        {
            inputs: [
                {
                    internalType: "address",
                    name: "to",
                    type: "address",
                },
                {internalType: "string", name: "uri", type: "string"},
            ],
            name: "safeMint",
            outputs: [],
            stateMutability: "payable",
            type: "function",
        },
        {
            inputs: [
                {
                    internalType: "bytes4",
                    name: "interfaceId",
                    type: "bytes4",
                },
            ],
            name: "supportsInterface",
            outputs: [{internalType: "bool", name: "", type: "bool"}],
            stateMutability: "view",
            type: "function",
        },
        {
            inputs: [],
            name: "symbol",
            outputs: [{internalType: "string", name: "", type: "string"}],
            stateMutability: "view",
            type: "function",
        },
        {
            inputs: [
                {
                    internalType: "uint256",
                    name: "tokenId",
                    type: "uint256",
                },
            ],
            name: "tokenURI",
            outputs: [{internalType: "string", name: "", type: "string"}],
            stateMutability: "view",
            type: "function",
        },
        {
            inputs: [
                {
                    internalType: "address",
                    name: "newOwner",
                    type: "address",
                },
            ],
            name: "transferOwnership",
            outputs: [],
            stateMutability: "payable",
            type: "function",
        },
    ];

    // tests chain
    const privateKey =
        "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80";
    const provider = ethers.getDefaultProvider("http://localhost:8545/");

    const contractAddress = "0x5fbdb2315678afecb367f032d93f642f64180aa3";
    const walletWithProvider = new ethers.Wallet(privateKey, provider);

    const contract = new ethers.Contract(contractAddress, abi, provider);
    const connectContract = contract.connect(walletWithProvider);
    // tests chain

    const getContractEvents = async () => {
        const filter = await connectContract.queryFilter("Transfer");

        filter.forEach(async (event) => {
            const topics = event.topics;
            const topicToWallet = topics[2].slice(-40);
            // topicToWallet === walletWithProvider.address.slice(-40).toLowerCase()
            console.log(await connectContract.tokenURI(topics[3]));
        });
    };
    // getContractEvents();
</script>
<script
        type="text/javascript"
        src="https://cdn.jsdelivr.net/npm/toastify-js"
></script>
<script>
    const mintForm = document.getElementById("mint_form");
    const burnForm = document.getElementById("burn_form");
    const batchForm = document.getElementById("batch_form");

    mintForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        const formData = new FormData(mintForm);
        const uri = formData.get("metadata_link");
        const to = formData.get("wallet_address");

        await connectContract.safeMint(to, uri);
    });

    // сжигает в кокалке
    burnForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        const formData = new FormData(burnForm);
        const id = formData.get("id");

        await connectContract.burn(id);
    });

    batchForm.addEventListener("submit", async (event) => {
        event.preventDefault();
        let error = false;
        const formData = new FormData(batchForm);
        const walletsData = formData.get("addresses");
        const walletsArray = walletsData.split("\n");

        walletsArray.forEach((wallet, index) => {
            if (!/^0x[a-fA-F0-9]{40}$/.test(wallet)) {
                Toastify({
                    text: `Неправильный адрес ${wallet}`,
                    className: "error",
                    position: "center",
                    gravity: "bottom",
                }).showToast();
                error = true;
            }
        });

        const uniqueWalletsArray = Array.from(new Set(walletsArray)); // без дубликатов массив

        if (!error) {
            // тут код для обработки адресов, либо напиши отдельную функцию и тут вызови ее передав адреса

            // работает, но нужно второе поле для ссылок на метаданные рядом или снизу
            // await connectContract.safeBatchMint(walletsArray, urisArray);
            const metadata_link = formData.get('metadata_uri')
            await connectContract.safeBatchMint(uniqueWalletsArray, metadata_link);
        }
    });
</script>
</body>
